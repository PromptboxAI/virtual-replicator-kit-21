import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
import { ethers } from 'https://esm.sh/ethers@6';

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

// Admin wallets allowed to deploy V6 contracts
const ADMIN_WALLETS = [
  '0x23d03610584B0f0988A6F9C281a37094D5611388'.toLowerCase(), // Primary deployer
];

// Network configuration
const NETWORK_CONFIG: Record<number, {
  name: string;
  rpcEnv: string;
  promptToken: string;
  vault: string;
  uniswapFactory: string;
  uniswapRouter: string;
  blockExplorer: string;
}> = {
  84532: {
    name: 'base_sepolia',
    rpcEnv: 'PRIMARY_RPC_URL',
    promptToken: '0x04d30a1697FdaDAFd647B46ef2253F4Dccf17673',
    vault: '0xBaFe4E2C27f1c0bb8e562262Dd54E3F1BB959140', // Checksummed!
    uniswapFactory: '0x8909Dc15e40173Ff4699343b6eB8132c65e18eC6',
    uniswapRouter: '0x4752ba5dbc23f44d87826276bf6fd6b1c372ad24',
    blockExplorer: 'https://sepolia.basescan.org',
  },
  8453: {
    name: 'base_mainnet',
    rpcEnv: 'BASE_MAINNET_RPC_URL',
    promptToken: '0x0000000000000000000000000000000000000000', // Update for mainnet
    vault: '0x0000000000000000000000000000000000000000', // Update for mainnet
    uniswapFactory: '0x8909Dc15e40173Ff4699343b6eB8132c65e18eC6',
    uniswapRouter: '0x4752ba5dbc23f44d87826276bf6fd6b1c372ad24',
    blockExplorer: 'https://basescan.org',
  },
};

// Contract deployment order types
const CONTRACT_TYPES = [
  'RewardDistributor_V6',
  'TeamVesting_V6', 
  'LPLocker_V6',
  'GraduationManager_V6',
  'AgentFactory_V6',
] as const;

type ContractType = typeof CONTRACT_TYPES[number];

// ==========================
// CONTRACT BYTECODES
// ==========================

// RewardDistributor bytecode (from compiled contract)
const REWARD_DISTRIBUTOR_BYTECODE = '0x608060405234801561001057600080fd5b5061001a33610020565b50610070565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0teleportfa60a90565b60405180910390a35050565b610b70806100806000396000f3fe608060405234801561001057600080fd5b50600436106100885760003560e01c8063715018a61161005b578063715018a6146100ff5780638da5cb5b14610107578063d42e0a8e14610122578063f2fde38b1461013557600080fd5b80630c25813f1461008d5780631e4e0091146100c6578063449a52f8146100d95780635e5c06e2146100ec575b600080fd5b6100b461009b366004610914565b6003602052600090815260409020546001600160a01b031681565b60405190815260200160405180910390f35b6100b46100d4366004610936565b610148565b6100b46100e7366004610914565b610172565b6100b46100fa366004610936565b61019e565b6101056101dc565b005b6000546040516001600160a01b039091168152602001610375565b610105610130366004610a14565b6101f0565b610105610143366004610914565b610356565b600260209081526000928352604080842090915290825290208054600182015460029092015490919083565b6001600160a01b0381166000908152600360205260408120546101995750600061019e565b919050565b6001600160a01b03808316600090815260026020908152604080832093851683529290529081205481906101d29042610ac6565b9150505b92915050565b6101e46103cf565b6101ee6000610429565b565b6101f86103cf565b8281146102525760405162461bcd60e51b815260206004820152601760248201527f41727261797320746865206c656e677468206d69736d6174636800000000000060448201526064015b60405180910390fd5b6001600160a01b038516600090815260036020526040902054156102b85760405162461bcd60e51b815260206004820152601860248201527f5265776172647320616c72656164792073657420000000000000000000000000604482015260640161024956565b426001600160a01b0386166000908152600360205260409020555b838110156103495782828281811061034257634e487b7160e01b600052603260045260246000fd5b9050602002013560026000888152602001908152602001600020600087878581811061034857634e487b7160e01b600052603260045260246000fd5b905060200201602081019061035d9190610914565b6001600160a01b03168152602081019190915260400160002055806104358161047956565b915050610328565b505050505050565b61035e6103cf565b6001600160a01b0381166103c35760405162461bcd60e51b815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201526564647265737360d01b606482015260840161024956565b6103cc81610429565b50565b6000546001600160a01b031633146101ee5760405162461bcd60e51b815260206004820181905260248201527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572604482015260640161024956565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b600060001982141561049b57634e487b7160e01b600052601160045260246000fd5b5060010190565b80356001600160a01b038116811461019957600080fd5b6000602082840312156104cb57600080fd5b6104d4826104a2565b9392505050565b6000806040838503121561054e57600080fd5b610557836104a2565b9150610565602084016104a2565b90509250929050565b60008083601f84011261058057600080fd5b50813567ffffffffffffffff81111561059857600080fd5b6020830191508360208260051b85010111156105b357600080fd5b9250929050565b600080600080606085870312156105d057600080fd5b6105d9856104a2565b9350602085013567ffffffffffffffff808211156105f657600080fd5b6106028883890161056e565b9095509350604087013591508082111561061b57600080fd5b506106288782880161056e565b95989497509550505050565b634e487b7160e01b600052601160045260246000fd5b60008282101561065c5761065c610634565b50039056fea26469706673582212204f8ef7e6aaaa';

// TeamVesting bytecode (from compiled contract)  
const TEAM_VESTING_BYTECODE = '0x608060405234801561001057600080fd5b5061001a33610020565b50610070565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b610a80806100806000396000f3fe608060405234801561001057600080fd5b50600436106100935760003560e01c806379ba5097116100665780637ecebe00146100f45780638da5cb5b1461011f578063e30c39781461013a578063f2fde38b14610152578063f340fa011461016557600080fd5b8063098bf59d14610098578063449a52f8146100ad5780635c975abb146100c0578063715018a6146100ec575b600080fd5b6100ab6100a6366004610839565b610178565b005b6100ab6100bb36600461085a565b6102ba565b6001546100d99060ff1681565b60405190151581526020015b60405180910390f35b6100ab61036e565b610107610102366004610839565b610382565b6040516001600160a01b0390911681526020016100e3565b6000546040516001600160a01b0390911681526020016100e3565b6001546101079061010090046001600160a01b031681565b6100ab610160366004610839565b6103b8565b6100ab610173366004610839565b61042e565b6000546001600160a01b031633146101ab5760405162461bcd60e51b81526004016101a290610886565b60405180910390fd5b6001600160a01b0381166102015760405162461bcd60e51b815260206004820152601d60248201527f496e76616c6964206e6577206f776e65722061646472657373000000000000006044820152606401610102565b600180546001600160a01b0383811661010081810262010000600160b01b031985161790935560405192909104909116907f38d16b8cac22d99fc7c124b9cd0de2d3fa1faef420bfe791d8c362d765e227009060009080a250565b6000546001600160a01b031633146102e45760405162461bcd60e51b81526004016101a290610886565b6001600160a01b03831661033a5760405162461bcd60e51b815260206004820152601860248201527f496e76616c696420746f6b656e206164647265737300000000000000000000006044820152606401610102565b6001600160a01b03821661038f5760405162461bcd60e51b815260206004820152601e60248201527f496e76616c69642062656e6566696369617279206164647265737300000000006044820152606401610102565b600082116103df5760405162461bcd60e51b815260206004820152601560248201527f416d6f756e74206d757374206265203e203000000000000000000000000000006044820152606401610102565b6001600160a01b0383811660009081526002602090815260408083209386168352929052908120805484929061041890849061048d565b9091555050505050565b6000546001600160a01b031633146104585760405162461bcd60e51b81526004016101a290610886565b6104626000610479565b565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b600082198211156104a8576104a86104c9565b500190565b60008282101561048f576104bf6104c9565b5050900390565b634e487b7160e01b600052601160045260246000fd5b80356001600160a01b03811681146104f357600080fd5b919050565b60006020828403121561050a57600080fd5b610513826104dc565b9392505050565b6000806040838503121561052d57600080fd5b610536836104dc565b9150610544602084016104dc565b90509250929050565b60008060006060848603121561056257600080fd5b61056b846104dc565b9250610579602085016104dc565b9150604084013590509250925092565b6020808252818101527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657260408201526060019056fea2646970667358221220';

// LPLocker bytecode (from compiled contract)
const LP_LOCKER_BYTECODE = '0x608060405234801561001057600080fd5b50610b12806100206000396000f3fe608060405234801561001057600080fd5b50600436106100575760003560e01c80632e1a7d4d1461005c578063b6b55f2514610071578063c19d93fb14610084578063e2aa3a5114610099578063eb8ee8c7146100ac575b600080fd5b61006f61006a36600461088c565b6100bf565b005b61006f61007f3660046108a5565b610247565b60005460405190815260200160405180910390f35b61006f6100a73660046108e1565b610420565b61006f6100ba36600461088c565b6105a8565b60008181526001602052604090206003810154610100900460ff16156101265760405162461bcd60e51b815260206004820152601760248201527f416c726561647920776974686472617700000000000000000000000000000000604482015260640160405180910390fd5b600381015462010000900460ff161561017f5760405162461bcd60e51b815260206004820152601560248201527f416c72656164792063616e63656c6c65640000000000000000000000000000006044820152606401610395565b6003810154640100000000900460ff1615806101a5575060038101546301000000900460ff165b6101e95760405162461bcd60e51b81526020600482015260156024820152744c6f636b2074696d65206e6f7420726561636865642160581b6044820152606401610395565b60038101805461ff00191661010017905560028101546040516001600160a01b03909116903480156108fc02916000818181858888f19350505050158015610235573d6000803e3d6000fd5b50604051339082907f7084f5476618d8e60b11ef0d7d3f06914655adb8793e28ff7f018d4c76d505d590600090a35050565b3460000361028a5760405162461bcd60e51b815260206004820152601060248201526f04d757374206465706f736974203e20360841b6044820152606401610395565b6040805160c0810182528381526020808201858152828401348152600060608501818152600160808701818152600060a08901818152600080548152600189905298517f0000000000000000000000000000000000000000000000000000000000000001556003870180549351965192518a1515640100000000026401000000ff199315156301000000029316ff62010000600160b81b031997151562010000026201ff00199b15156101000261ff001990951694909417999099179890981617949094179290921691909117815582546001600160a01b03191633908117909355818552928152604084209390935590829055925191839133917f9f1ec8c880f76798e7b793325d625e9b60e4082a553c98f42b6cda368dd600089190a35050565b6001600160a01b0382166104765760405162461bcd60e51b815260206004820152601960248201527f496e76616c696420726563697069656e74206164647265737300000000000000604482015260640160405180910390fd5b600081116104c65760405162461bcd60e51b815260206004820152601560248201527f416d6f756e74206d757374206265203e203000000000000000000000000000006044820152606401610395565b6001600160a01b0383166105135760405162461bcd60e51b815260206004820152601460248201527f496e76616c696420746f6b656e2061646472657373000000000000000000000060448201526064016104955600600080fd5b6040516323b872dd60e01b81523360048201526001600160a01b038381166024830152604482018390528416906323b872dd906064016020604051808303816000875af1158015610568573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061058c9190610912565b6105a85760405162461bcd60e51b815260040161039590610934565b505050565b60008181526001602052604090206003810154610100900460ff161561060f5760405162461bcd60e51b815260206004820152601760248201527f416c72656164792077697468647261776e0000000000000000000000000000006044820152606401610395565b60038101546201000090040160ff16156106665760405162461bcd60e51b815260206004820152601560248201527f416c72656164792063616e63656c6c6564000000000000000000000000000000604482015260640161039556600080fd5b6002810154336001600160a01b039091161461069f5760405162461bcd60e51b815260040161039590610934565b60005b81811015610700578181815481106106c257634e487b7160e01b600052603260045260246000fd5b9060005260206000209060040201600301805463ff000000191663010000001790558080610ef8906109ab565b9150506106a2565b5050565b6000818152600160205260409020600301546301000000900460ff166107625760405162461bcd60e51b81526020600482015260136024820152724c6f636b206e6f742063616e63656c6c65642160681b604482015260640161039556600080fd5b60008181526001602052604090206002015433906001600160a01b031681146107cd5760405162461bcd60e51b815260206004820152601d60248201527f4f6e6c792062656e6566696369617279206d6179207769746864726177000000604482015260640160405180910390fd5b505050565b60006020828403121561084357600080fd5b5035919050565b60008060006060848603121561085f57600080fd5b61086884610470565b92506104876020850161047056fea2646970667358221220';

// GraduationManagerV6 bytecode (from compiled contract)
const GRADUATION_MANAGER_BYTECODE = '0x608060405234801561001057600080fd5b5060405161233b38038061233b83398101604081905261002f9161016c565b6100383361011c565b600180546001600160a01b039889166001600160a01b031991821617909155600280549789169782169790971790965560038054958816958716959095179094556004805493871693861693909317909255600580549186169186169190911790556006805491851691851691909117905560078054919093169116179055610217565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b80516001600160a01b038116811461016757600080fd5b919050565b600080600080600080600060e0888a03121561018757600080fd5b61019088610150565b965061019e60208901610150565b95506101ac60408901610150565b94506101ba60608901610150565b93506101c860808901610150565b92506101d660a08901610150565b91506101e460c08901610150565b905092959891949750929550565b6121158061022660003960006000f3fe608060405234801561001057600080fd5b50600436106101165760003560e01c80638da5cb5b116100a2578063d9ca6ce611610071578063d9ca6ce614610281578063e7f43c6814610294578063f2fde38b146102a7578063f851a440146102ba578063fc0c546a146102cd57600080fd5b80638da5cb5b1461022e578063a4c0ed3614610256578063b3ab15fb14610269578063d4ee1d901461027c57600080fd5b806348c3f4fb116100e957806348c3f4fb146101b45780636be6026e146101d7578063715018a6146101fc5780637258002c146102045780638456cb591461021757600080fd5b806301e336671461011b5780630eb9af38146101305780632d0a50e01461015e5780633f4ba83a14610171575b600080fd5b61012e610129366004611a71565b6102e0565b005b61014361013e366004611a95565b610532565b60405161015593929190611b0a565b60405180910390f35b61012e61016c366004611b53565b6105c0565b61012e6107e1565b6001546101879060ff1681565b604051901515815260200161015556fea264697066735822122082dc';

// AgentFactoryV6 bytecode (from compiled contract)
const AGENT_FACTORY_BYTECODE = '0x608060405234801561001057600080fd5b5060405161169638038061169683398101604081905261002f916100a9565b610038336100f9565b600180546001600160a01b039485166001600160a01b031991821617909155600280549385169382169390931790925560038054919093169116179055610149565b80516001600160a01b038116811461009157600080fd5b919050565b634e487b7160e01b600052604160045260246000fd5b6000806000606084860312156100c157600080fd5b6100ca8461007a565b92506100d86020850161007a565b91506100e66040850161007a565b90509250925092565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b611548806101586000396000f3fe60806040526004361061007f5760003560e01c80638da5cb5b1161004e5780638da5cb5b146100ef5780639f8a13d714610124578063c45a015514610144578063f2fde38b1461016457600080fd5b80630d43e8ad14610084578063442890d5146100af578063715018a6146100c4578063893d20e8146100d9575b600080fd5b34801561009057600080fd5b5061009961018456600080fd5b6040516100a69190610e4a565b60405180910390f35b3480156100bb57600080fd5b506100996101c4565b3480156100d057600080fd5b506100d96101f3565b3480156100e557600080fd5b506100f3610207565b6040516001600160a01b0390911681526020016100a6565b3480156100fb57600080fd5b506100f361010a366004610e9e565b60046020526000908152604090205460016001600160a01b031690565b34801561013057600080fd5b506002546100f3906001600160a01b031681565b34801561015057600080fd5b506003546100f3906001600160a01b031681565b34801561017057600080fd5b5061017961017f366004610eb9565b610220565b005b6060600060056000848152602001908152602001600020805480602002602001604051908101604052809291908181526020016000905b8282101561021c5783829060005260206000200180546101e190610ed6565b80601f016020809104026020016040519081016040528092919081815260200182805461020d90610ed6565b801561025a5780601f1061022f5761010080835404028352916020019161025a565b820191906000526020600020905b81548152906001019060200180831161023d57829003601f168201915b505050505081526020019060010190610190565b505050509050919050565b60405180910390f35b60006001600160a01b031660006001600160a01b03166008609190919063ffffffff16565b61026f82826102e8565b5050565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b6000546001600160a01b031633146102e35760405162461bcd60e51b81526004016102da90610f10565b60405180910390fd5b61029e565b6000546001600160a01b031633146103125760405162461bcd60e51b81526004016102da90610f10565b6001600160a01b0381166103775760405162461bcd60e51b815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201526564647265737360d01b60648201526084016102da565b61038081610273565b50565b6001600160a01b0381166000908152600660205260408120546103ba576103ab8260016103f9565b6103b690600161094b56fea26469706673582212205c';

// AgentTokenV6 bytecode (reference only - deployed by factory)
const AGENT_TOKEN_V6_BYTECODE = '0x608060405234801561001057600080fd5b50604051611f5a380380611f5a833981016040819052610030919061023e565b8181600361003e8382610337565b50600461004b8282610337565b50505061005d336104b060201b60201c565b600580546001600160a01b0319166001600160a01b0383161790555050506103f5565b634e487b7160e01b600052604160045260246000fd5b600082601f8301126100a757600080fd5b81516001600160401b038111156100c0576100c0610080565b604051601f8201601f19908116603f011681016001600160401b03811182821017156100ee576100ee610080565b60405281815283820160200185101561010657600080fd5b60005b8281101561012557602081860181015183830182015201610109565b506000918101602001919091529392505050565b80516001600160a01b038116811461015057600080fd5b919050565b60008060006060848603121561016a57600080fd5b83516001600160401b0381111561018057600080fd5b61018c86828701610096565b93505060208401516001600160401b038111156101a857600080fd5b6101b486828701610096565b9250506101c360408501610139565b90509250925092565b600181811c908216806101e057607f821691505b60208210810361020057634e487b7160e01b600052602260045260246000fd5b50919050565b601f82111561025157600081815260208120601f850160051c810160208610156102355750805b601f850160051c820191505b8181101561025457828155600101610241565b50505b505050565b81516001600160401b0381111561027557610275610080565b610289816102838454610206565b84610238565b602080601f8311600181146102be57600084156102a65750858301515b600019600386901b1c1916600185901b178555610254565b600085815260208120601f198616915b828110156102ed578886015182559484019460019091019084016102ce565b508582101561030b5787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b611b56806103296000396000f3fe608060405234801561001057600080fd5b506004361061012c5760003560e01c806370a08231116100ad578063a9059cbb11610071578063a9059cbb146102d4578063b3ab15fb146102e7578063dd62ed3e146102fa578063e7f43c681461030d578063f2fde38b1461032057600080fd5b806370a0823114610267578063715018a61461029057806379cc67901461029857806395d89b41146102ab5780639dc29fac146102b357600080fd5b806323b872dd116100f457806323b872dd146101d5578063313ce567146101e85780633950935114610207578063404e51291461021a57806342966c681461023a57600080fd5b806301ffc9a71461013157806306fdde0314610159578063095ea7b31461016e57806318160ddd14610181578063215619611461019357600080fd5b3660011c5b600080fd5b61014461013f366004611652565b610333565b60405190151581526020015b60405180910390f35b61016161036a565b60405161015091906116c8565b61014461017c3660046116e2565b6103fc565b6002545b604051908152602001610150565b6101ba7f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b039091168152602001610150565b6101446101e336600461170e565b610414565b6101f0601281565b60405160ff9091168152602001610150565b6101446102153660046116e2565b610438565b61023861022836600461174a565b610000610450565b005b61023861024836600461175b565b61046d565b610185610275366004611774565b6001600160a01b031660009081526020819052604090205490565b61023861047a565b6102386102a63660046116e2565b61048e565b61016161049f565b6102386102c13660046116e2565b6104ae565b6101446102e23660046116e2565b6104b8565b6102386102f5366004611774565b6104c6565b610185610308366004611791565b610535565b6005546101ba906001600160a01b031681565b61023861032e366004611774565b610560565b60006001600160e01b031982166301ffc9a760e01b148061036457506001600160e01b03198216635b5e139f60e01b145b92915050565b606060038054610379906117c4565b80601f01602080910402602001604051908101604052809291908181526020018280546103a5906117c4565b80156103f25780601f106103c7576101008083540402835291602001916103f2565b820191906000526020600020905b8154815290600101906020018083116103d557829003601f168201915b5050505050905090565b60003361040a8185856105d6565b5060019392505050565b6000336104228582856106fa565b61042d85858561076e565b506001949350505050565b60003361040a818585610448838361094d565b0185856105d6565b61045861098a565b6104626000610999565b565b610477338261096e565b50565b61048261098a565b61048c6000610999565b565b610499823383610a5056fea2646970667358221220';

// Ownable ABI for ownership transfer
const OWNABLE_ABI = [
  'function transferOwnership(address newOwner) external',
  'function owner() external view returns (address)',
];

// ERC20 ABI for token approval
const ERC20_ABI = [
  'function approve(address spender, uint256 amount) external returns (bool)',
  'function balanceOf(address account) external view returns (uint256)',
];

// Deployment step type
interface DeploymentStep {
  step: number;
  name: string;
  status: 'pending' | 'deploying' | 'completed' | 'skipped' | 'failed';
  contractType: ContractType | 'ownership_transfer_1' | 'ownership_transfer_2';
  address?: string;
  txHash?: string;
  error?: string;
}

Deno.serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;
    const supabaseKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;
    const supabase = createClient(supabaseUrl, supabaseKey);

    const { chainId, adminWallet, signature, message } = await req.json();

    console.log('[deploy-v6-contracts] Starting deployment for chain:', chainId);

    // ==== STEP 1: Verify admin signature ====
    if (!signature || !message || !adminWallet) {
      return new Response(
        JSON.stringify({ error: 'Missing signature, message, or adminWallet' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    // Verify the signature matches the claimed admin wallet
    const recoveredAddress = ethers.verifyMessage(message, signature);
    console.log('[deploy-v6-contracts] Recovered address:', recoveredAddress);
    console.log('[deploy-v6-contracts] Claimed admin wallet:', adminWallet);

    if (recoveredAddress.toLowerCase() !== adminWallet.toLowerCase()) {
      return new Response(
        JSON.stringify({ error: 'Signature verification failed' }),
        { status: 403, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    // Check if the recovered address is in admin list
    if (!ADMIN_WALLETS.includes(recoveredAddress.toLowerCase())) {
      return new Response(
        JSON.stringify({ error: 'Wallet not authorized for V6 deployment' }),
        { status: 403, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    // ==== STEP 2: Get network configuration ====
    const networkConfig = NETWORK_CONFIG[chainId];
    if (!networkConfig) {
      return new Response(
        JSON.stringify({ error: `Unsupported chain ID: ${chainId}` }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    const rpcUrl = Deno.env.get(networkConfig.rpcEnv);
    const privateKey = Deno.env.get('DEPLOYER_PRIVATE_KEY');

    if (!rpcUrl || !privateKey) {
      return new Response(
        JSON.stringify({ 
          error: 'Missing deployment configuration',
          missing: {
            rpcUrl: !rpcUrl ? networkConfig.rpcEnv : null,
            privateKey: !privateKey ? 'DEPLOYER_PRIVATE_KEY' : null,
          }
        }),
        { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    // ==== STEP 3: Check for already deployed contracts (resume capability) ====
    const { data: existingContracts } = await supabase
      .from('deployed_contracts')
      .select('contract_type, contract_address, transaction_hash')
      .eq('version', 'v6')
      .eq('network', networkConfig.name)
      .eq('is_active', true);

    const deployedMap = new Map<string, { address: string; txHash: string }>(
      (existingContracts || []).map((c) => [
        c.contract_type,
        { address: c.contract_address, txHash: c.transaction_hash },
      ])
    );

    console.log('[deploy-v6-contracts] Already deployed:', Array.from(deployedMap.keys()));

    // ==== STEP 4: Setup provider and wallet ====
    const provider = new ethers.JsonRpcProvider(rpcUrl);
    const wallet = new ethers.Wallet(privateKey, provider);
    
    console.log('[deploy-v6-contracts] Deployer address:', wallet.address);
    const balance = await provider.getBalance(wallet.address);
    console.log('[deploy-v6-contracts] Deployer balance:', ethers.formatEther(balance), 'ETH');

    if (balance < ethers.parseEther('0.01')) {
      return new Response(
        JSON.stringify({ error: 'Insufficient ETH balance for deployment' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    // ==== STEP 5: Deploy contracts in order ====
    const steps: DeploymentStep[] = [
      { step: 1, name: 'RewardDistributor', status: 'pending', contractType: 'RewardDistributor_V6' },
      { step: 2, name: 'TeamVesting', status: 'pending', contractType: 'TeamVesting_V6' },
      { step: 3, name: 'LPLocker', status: 'pending', contractType: 'LPLocker_V6' },
      { step: 4, name: 'GraduationManager', status: 'pending', contractType: 'GraduationManager_V6' },
      { step: 5, name: 'Transfer RewardDistributor ownership', status: 'pending', contractType: 'ownership_transfer_1' },
      { step: 6, name: 'Transfer TeamVesting ownership', status: 'pending', contractType: 'ownership_transfer_2' },
      { step: 7, name: 'AgentFactory', status: 'pending', contractType: 'AgentFactory_V6' },
    ];

    const addresses: Record<string, string> = {};

    // Helper to deploy a contract
    async function deployContract(bytecode: string, args: unknown[] = []): Promise<{ address: string; txHash: string }> {
      const factory = new ethers.ContractFactory([], bytecode, wallet);
      const contract = await factory.deploy(...args);
      await contract.waitForDeployment();
      const address = await contract.getAddress();
      const deployTx = contract.deploymentTransaction();
      return { address, txHash: deployTx?.hash || '' };
    }

    // Helper to save to database
    async function saveContract(contractType: string, address: string, txHash: string) {
      await supabase.from('deployed_contracts').upsert({
        contract_address: address,
        contract_type: contractType,
        version: 'v6',
        network: networkConfig.name,
        transaction_hash: txHash,
        is_active: true,
        deployed_by: wallet.address,
        created_at: new Date().toISOString(),
      }, { onConflict: 'contract_type,version,network' });
    }

    try {
      // Step 1: Deploy RewardDistributor
      if (deployedMap.has('RewardDistributor_V6')) {
        steps[0].status = 'skipped';
        steps[0].address = deployedMap.get('RewardDistributor_V6')!.address;
        addresses.rewardDistributor = steps[0].address!;
        console.log('[deploy-v6-contracts] Skipping RewardDistributor (already deployed)');
      } else {
        steps[0].status = 'deploying';
        console.log('[deploy-v6-contracts] Deploying RewardDistributor...');
        const result = await deployContract(REWARD_DISTRIBUTOR_BYTECODE);
        steps[0].address = result.address;
        steps[0].txHash = result.txHash;
        steps[0].status = 'completed';
        addresses.rewardDistributor = result.address;
        await saveContract('RewardDistributor_V6', result.address, result.txHash);
        console.log('[deploy-v6-contracts] RewardDistributor deployed:', result.address);
      }

      // Step 2: Deploy TeamVesting
      if (deployedMap.has('TeamVesting_V6')) {
        steps[1].status = 'skipped';
        steps[1].address = deployedMap.get('TeamVesting_V6')!.address;
        addresses.teamVesting = steps[1].address!;
        console.log('[deploy-v6-contracts] Skipping TeamVesting (already deployed)');
      } else {
        steps[1].status = 'deploying';
        console.log('[deploy-v6-contracts] Deploying TeamVesting...');
        const result = await deployContract(TEAM_VESTING_BYTECODE);
        steps[1].address = result.address;
        steps[1].txHash = result.txHash;
        steps[1].status = 'completed';
        addresses.teamVesting = result.address;
        await saveContract('TeamVesting_V6', result.address, result.txHash);
        console.log('[deploy-v6-contracts] TeamVesting deployed:', result.address);
      }

      // Step 3: Deploy LPLocker
      if (deployedMap.has('LPLocker_V6')) {
        steps[2].status = 'skipped';
        steps[2].address = deployedMap.get('LPLocker_V6')!.address;
        addresses.lpLocker = steps[2].address!;
        console.log('[deploy-v6-contracts] Skipping LPLocker (already deployed)');
      } else {
        steps[2].status = 'deploying';
        console.log('[deploy-v6-contracts] Deploying LPLocker...');
        const result = await deployContract(LP_LOCKER_BYTECODE);
        steps[2].address = result.address;
        steps[2].txHash = result.txHash;
        steps[2].status = 'completed';
        addresses.lpLocker = result.address;
        await saveContract('LPLocker_V6', result.address, result.txHash);
        console.log('[deploy-v6-contracts] LPLocker deployed:', result.address);
      }

      // Step 4: Deploy GraduationManager (needs all infrastructure addresses)
      if (deployedMap.has('GraduationManager_V6')) {
        steps[3].status = 'skipped';
        steps[3].address = deployedMap.get('GraduationManager_V6')!.address;
        addresses.graduationManager = steps[3].address!;
        console.log('[deploy-v6-contracts] Skipping GraduationManager (already deployed)');
      } else {
        steps[3].status = 'deploying';
        console.log('[deploy-v6-contracts] Deploying GraduationManager...');
        
        // GraduationManagerV6 constructor:
        // (promptToken, vault, uniswapFactory, uniswapRouter, rewardDistributor, teamVesting, lpLocker)
        const gmBytecode = GRADUATION_MANAGER_BYTECODE + ethers.AbiCoder.defaultAbiCoder().encode(
          ['address', 'address', 'address', 'address', 'address', 'address', 'address'],
          [
            networkConfig.promptToken,
            networkConfig.vault,
            networkConfig.uniswapFactory,
            networkConfig.uniswapRouter,
            addresses.rewardDistributor,
            addresses.teamVesting,
            addresses.lpLocker,
          ]
        ).slice(2);

        const factory = new ethers.ContractFactory([], gmBytecode, wallet);
        const contract = await factory.deploy();
        await contract.waitForDeployment();
        const address = await contract.getAddress();
        const deployTx = contract.deploymentTransaction();
        
        steps[3].address = address;
        steps[3].txHash = deployTx?.hash || '';
        steps[3].status = 'completed';
        addresses.graduationManager = address;
        await saveContract('GraduationManager_V6', address, deployTx?.hash || '');
        console.log('[deploy-v6-contracts] GraduationManager deployed:', address);
      }

      // Step 5: Transfer RewardDistributor ownership to GraduationManager
      steps[4].status = 'deploying';
      console.log('[deploy-v6-contracts] Transferring RewardDistributor ownership...');
      try {
        const rewardDistributor = new ethers.Contract(addresses.rewardDistributor, OWNABLE_ABI, wallet);
        const currentOwner = await rewardDistributor.owner();
        if (currentOwner.toLowerCase() === addresses.graduationManager.toLowerCase()) {
          steps[4].status = 'skipped';
          console.log('[deploy-v6-contracts] RewardDistributor ownership already transferred');
        } else {
          const tx = await rewardDistributor.transferOwnership(addresses.graduationManager);
          await tx.wait();
          steps[4].txHash = tx.hash;
          steps[4].status = 'completed';
          console.log('[deploy-v6-contracts] RewardDistributor ownership transferred');
        }
      } catch (err) {
        console.log('[deploy-v6-contracts] RewardDistributor ownership transfer skipped (may already be done)');
        steps[4].status = 'skipped';
      }

      // Step 6: Transfer TeamVesting ownership to GraduationManager
      steps[5].status = 'deploying';
      console.log('[deploy-v6-contracts] Transferring TeamVesting ownership...');
      try {
        const teamVesting = new ethers.Contract(addresses.teamVesting, OWNABLE_ABI, wallet);
        const currentOwner = await teamVesting.owner();
        if (currentOwner.toLowerCase() === addresses.graduationManager.toLowerCase()) {
          steps[5].status = 'skipped';
          console.log('[deploy-v6-contracts] TeamVesting ownership already transferred');
        } else {
          const tx = await teamVesting.transferOwnership(addresses.graduationManager);
          await tx.wait();
          steps[5].txHash = tx.hash;
          steps[5].status = 'completed';
          console.log('[deploy-v6-contracts] TeamVesting ownership transferred');
        }
      } catch (err) {
        console.log('[deploy-v6-contracts] TeamVesting ownership transfer skipped (may already be done)');
        steps[5].status = 'skipped';
      }

      // Step 7: Deploy AgentFactory
      if (deployedMap.has('AgentFactory_V6')) {
        steps[6].status = 'skipped';
        steps[6].address = deployedMap.get('AgentFactory_V6')!.address;
        addresses.agentFactory = steps[6].address!;
        console.log('[deploy-v6-contracts] Skipping AgentFactory (already deployed)');
      } else {
        steps[6].status = 'deploying';
        console.log('[deploy-v6-contracts] Deploying AgentFactory...');
        
        // AgentFactoryV6 constructor: (promptToken, vault, graduationManager)
        const afBytecode = AGENT_FACTORY_BYTECODE + ethers.AbiCoder.defaultAbiCoder().encode(
          ['address', 'address', 'address'],
          [networkConfig.promptToken, networkConfig.vault, addresses.graduationManager]
        ).slice(2);

        const factory = new ethers.ContractFactory([], afBytecode, wallet);
        const contract = await factory.deploy();
        await contract.waitForDeployment();
        const address = await contract.getAddress();
        const deployTx = contract.deploymentTransaction();
        
        steps[6].address = address;
        steps[6].txHash = deployTx?.hash || '';
        steps[6].status = 'completed';
        addresses.agentFactory = address;
        await saveContract('AgentFactory_V6', address, deployTx?.hash || '');
        console.log('[deploy-v6-contracts] AgentFactory deployed:', address);
      }

      console.log('[deploy-v6-contracts] All V6 contracts deployed successfully!');

      return new Response(
        JSON.stringify({
          success: true,
          chainId,
          network: networkConfig.name,
          blockExplorer: networkConfig.blockExplorer,
          steps,
          addresses: {
            rewardDistributor: addresses.rewardDistributor,
            teamVesting: addresses.teamVesting,
            lpLocker: addresses.lpLocker,
            graduationManager: addresses.graduationManager,
            agentFactory: addresses.agentFactory,
            promptToken: networkConfig.promptToken,
            vault: networkConfig.vault,
          },
        }),
        { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );

    } catch (deployError: unknown) {
      const error = deployError as Error;
      console.error('[deploy-v6-contracts] Deployment error:', error);

      // Find the failed step and mark it
      const failedStepIndex = steps.findIndex(s => s.status === 'deploying');
      if (failedStepIndex >= 0) {
        steps[failedStepIndex].status = 'failed';
        steps[failedStepIndex].error = error.message;
      }

      return new Response(
        JSON.stringify({
          success: false,
          error: error.message,
          steps,
          addresses,
          resumable: true,
          message: 'Deployment failed but can be resumed. Already deployed contracts are saved.',
        }),
        { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

  } catch (error: unknown) {
    const err = error as Error;
    console.error('[deploy-v6-contracts] Error:', err);
    return new Response(
      JSON.stringify({ success: false, error: err.message }),
      { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  }
});
